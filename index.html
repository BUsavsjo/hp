<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enhets- och kontraktsöversikt</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f1f5f9;
      color: #111827;
      padding: 30px;
    }
    h2 {
      margin-bottom: 20px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .controls label {
      margin-right: 6px;
      font-weight: 600;
    }
    input, select {
      margin: 5px 10px 15px 0;
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    select[multiple] {
      height: 120px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 12px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background-color: #f3f4f6;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background-color: #f9fafb;
    }
    .table-container {
      overflow-x: auto;
    }
    .instructions {
      background: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
    }
    .instructions img {
      max-width: 50%;
      height: auto;
      border-radius: 4px;
      margin-bottom: 10px;
      transition: transform 0.3s ease;
    }
    .instructions img:hover {
      transform: scale(1.1);
    }
    @media (max-width: 600px) {
      .controls label {
        flex-basis: 100%;
      }
      input, select {
        width: 100%;
      }
    }
    #summary {
      margin-top: 20px;
      font-weight: 600;
      background: #e0f2fe;
      padding: 10px;
      border-radius: 6px;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h2>Sök och sortera enheter och kontrakt</h2>

  <div class="instructions">
    <a href="https://h22155.www2.hpe.com/" target="_blank" rel="noopener noreferrer">
      <img id="instructionsImage" src="hpbild.png" alt="Instruktionsbild">
    </a>
    <p>Ladda hem HP-filen (”uttag Serienummer”), se bild ovan. Ladda sedan upp filen här – allt hanteras lokalt i din webbläsare.</p>
  </div>

  <div class="controls">
    <label for="uploadFile">Ladda upp .xlsx:</label>
    <input type="file" id="uploadFile" accept=".xlsx" onchange="loadExcel(event)">

    <label for="searchSerial">Sök serienummer:</label>
    <input type="text" id="searchSerial" oninput="filterTable()">

    <label for="searchContract">Sök kontraktsnummer:</label>
    <input type="text" id="searchContract" oninput="filterTable()">

    <label for="filterType">Produkt:</label>
    <select id="filterType" multiple onchange="handleSelectChange(event); filterTable()"></select>

    <label for="filterYear">Förfalloår:</label>
    <select id="filterYear" multiple onchange="handleSelectChange(event); filterTable()"></select>

    <label for="filterDuration">Löptid (mån):</label>
    <select id="filterDuration" multiple onchange="handleSelectChange(event); filterTable()"></select>

    <label for="filterLocation">Plats:</label>
    <select id="filterLocation" multiple onchange="handleSelectChange(event); filterTable()"></select>

    <label for="filterStatus">Tillgångsstatus:</label>
    <select id="filterStatus" multiple onchange="handleSelectChange(event); filterTable()"></select>

    <label class="checkbox-label">
      <input type="checkbox" id="filterPreschool" onchange="filterTable()">
      Förskola
    </label>
  </div>

  <div class="table-container">
    <table id="contractTable">
      <thead>
        <tr>
          <th>Serienummer</th>
          <th>Kontraktsnummer</th>
          <th>Tillgång</th>
          <th>Förfallodatum</th>
          <th>Löptid (mån)</th>
          <th>Kvartalshyra</th>
          <th>Plats</th>
          <th>Tillgångsstatus</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="summary"></div>

<script>
let data = [];

const tableBody = document.querySelector("#contractTable tbody");
const filterType = document.getElementById("filterType");
const filterYear = document.getElementById("filterYear");
const filterDuration = document.getElementById("filterDuration");
const filterLocation = document.getElementById("filterLocation");
const filterStatus = document.getElementById("filterStatus");
const filterPreschool = document.getElementById("filterPreschool");
const searchSerial = document.getElementById("searchSerial");
const searchContract = document.getElementById("searchContract");
const summaryDiv = document.getElementById("summary");

const preschoolSearchTerms = [
  "förskoleområde 1 i sävsjö",
  "förskoleområde 2 i sävsjö",
  "förskoleområde vrigstad",
  "förskolan snickaregården rörvik",
  "förskolan appelhagen stockaryd",
  "spången förskola",
  "sörgården förskola",
  "fantasia förskola",
  "ripan förskola",
  "paletten förskola",
  "prästhagen förskola",
  "tuvan förskola",
  "appelhagen förskola",
  "snickaregården förskola",
  "6312",
  "6314",
  "6309",
  "6305",
  "6306",
  "41030",
  "41060",
  "41070",
  "41080",
  "41120",
  "41130",
  "41140",
  "46210",
  "46310"
];

function addAllOption(selectEl) {
  selectEl.add(new Option("Alla", "all"));
}

function handleSelectChange(event) {
  const selectEl = event.target;
  const allOption = selectEl.options[0];
  const otherOptions = Array.from(selectEl.options).slice(1);
  if (allOption.selected) {
    otherOptions.forEach(opt => opt.selected = true);
  }
  allOption.selected = otherOptions.every(opt => opt.selected);
}

function parseQuarterlyCost(value) {
  if (typeof value === "number") {
    return value;
  }

  if (value === null || value === undefined) {
    return NaN;
  }

  let normalized = String(value).trim().replace(/\skr/gi, "");
  if (!normalized) {
    return NaN;
  }

  normalized = normalized.replace(/[^0-9,.-]/g, "");
  if (normalized.includes(",")) {
    normalized = normalized.replace(/\./g, "");
    normalized = normalized.replace(/,/g, ".");
  }

  const parsed = Number(normalized);
  return Number.isFinite(parsed) ? parsed : NaN;
}

function distributeQuarterlyCostPerYear(startDate, endDate, quarterlyCost) {
  const result = {};
  const quarterly = parseQuarterlyCost(quarterlyCost);

  if (!Number.isFinite(quarterly)) {
    return result;
  }

  let start = new Date(startDate);
  let end = new Date(endDate);

  const hasValidStart = !Number.isNaN(start.getTime());
  const hasValidEnd = !Number.isNaN(end.getTime());

  if (!hasValidStart && !hasValidEnd) {
    return result;
  }

  if (!hasValidStart || !hasValidEnd) {
    const fallbackDate = hasValidStart ? start : end;
    const fallbackYear = fallbackDate.getFullYear();
    if (!Number.isNaN(fallbackYear)) {
      result[fallbackYear] = (result[fallbackYear] || 0) + quarterly * 4;
    }
    return result;
  }

  if (start > end) {
    const temp = start;
    start = end;
    end = temp;
  }

  const monthlyCost = quarterly / 3;
  const startYear = start.getFullYear();
  const endYear = end.getFullYear();

  for (let year = startYear; year <= endYear; year++) {
    const yearStart = new Date(year, 0, 1);
    const yearEnd = new Date(year, 11, 31);
    const from = start > yearStart ? start : yearStart;
    const to = end < yearEnd ? end : yearEnd;
    const months =
      (to.getFullYear() - from.getFullYear()) * 12 +
      (to.getMonth() - from.getMonth()) + 1;
    if (months > 0) {
      result[year] = (result[year] || 0) + months * monthlyCost;
    }
  }

  if (Object.keys(result).length === 0) {
    const fallbackYear = start.getFullYear();
    if (!Number.isNaN(fallbackYear)) {
      result[fallbackYear] = (result[fallbackYear] || 0) + quarterly * 4;
    }
  }

  return result;
}

function loadExcel(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const workbook = XLSX.read(e.target.result, { type: "binary", cellDates: true });
    const sheetName = workbook.SheetNames.find(name => name.includes("Europa"));
    const sheet = workbook.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(sheet);

    data = rows.map(row => [
      row["SERIENUMMER"] || "",
      row["Kontraktsnummer"] || "",
      row["Tillgångsbeskrivning"] || "",
      (row["Kontraktets förfallodatum"] instanceof Date) ? row["Kontraktets förfallodatum"] : new Date(row["Kontraktets förfallodatum"]),
      row["Löptid"] || 0,
      parseQuarterlyCost(row["Hyra"]) || 0,
      row["Plats"] || "",
      row["Tillgångsstatus"] || "",
      (row["StartDatum"] instanceof Date) ? row["StartDatum"] : new Date(row["StartDatum"])
    ]);

    initFilters();
    filterTable();
  };
  reader.readAsBinaryString(file);
}

function initFilters() {
  [filterType, filterYear, filterDuration, filterLocation, filterStatus].forEach(select => {
    select.innerHTML = "";
    addAllOption(select);
  });

  const types = new Set(), years = new Set(), durations = new Set(), locations = new Set(), statuses = new Set();
  data.forEach(row => {
    types.add(row[2]);
    years.add(new Date(row[3]).getFullYear());
    durations.add(row[4]);
    locations.add(row[6]);
    statuses.add(row[7]);
  });

  [...types].sort().forEach(t => filterType.add(new Option(t, t)));
  [...years].sort().forEach(y => filterYear.add(new Option(y, y)));
  [...durations].sort((a, b) => a - b).forEach(d => filterDuration.add(new Option(d, d)));
  [...locations].sort().forEach(loc => filterLocation.add(new Option(loc, loc)));
  [...statuses].sort().forEach(s => filterStatus.add(new Option(s, s)));

  [filterType, filterYear, filterDuration, filterLocation, filterStatus].forEach(select =>
    Array.from(select.options).forEach(opt => opt.selected = true)
  );
}

function getSelectedValues(selectEl) {
  const values = Array.from(selectEl.selectedOptions).map(option => option.value);
  return values.includes("all") ? [] : values.filter(v => v !== "all");
}

function filterTable() {
  const types = getSelectedValues(filterType);
  const years = getSelectedValues(filterYear);
  const durations = getSelectedValues(filterDuration);
  const locations = getSelectedValues(filterLocation);
  const statuses = getSelectedValues(filterStatus);
  const requirePreschool = filterPreschool.checked;
  const serialQuery = searchSerial.value.toLowerCase();
  const contractQuery = searchContract.value.toLowerCase();
  let totalByYear = {};
  const matchedRows = [];

  data.forEach(row => {
    const matchType = types.length === 0 || types.includes(row[2]);
    const matchYear = years.length === 0 || years.includes(new Date(row[3]).getFullYear().toString());
    const matchDuration = durations.length === 0 || durations.includes(row[4].toString());
    const matchLocation = locations.length === 0 || locations.includes(row[6]);
    const matchStatus = statuses.length === 0 || statuses.includes(row[7]);
    const matchSerial = !serialQuery || row[0].toLowerCase().includes(serialQuery);
    const matchContract = !contractQuery || row[1].toLowerCase().includes(contractQuery);
    const matchPreschool = !requirePreschool || preschoolSearchTerms.some(term => row[6].toLowerCase().includes(term));

    if (matchType && matchYear && matchDuration && matchLocation && matchStatus && matchSerial && matchContract && matchPreschool) {
      matchedRows.push(row);
    }
  });

  if (requirePreschool) {
    matchedRows.sort((a, b) => a[6].localeCompare(b[6], "sv"));
  }

  tableBody.innerHTML = "";

  matchedRows.forEach(row => {
    const tr = document.createElement("tr");
    row.slice(0, 8).forEach(cell => {
      const td = document.createElement("td");
      td.textContent = cell;
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);

    const yearSplit = distributeQuarterlyCostPerYear(row[8], row[3], row[5]);
    Object.entries(yearSplit).forEach(([year, amount]) => {
      if (!Number.isFinite(amount)) {
        return;
      }
      totalByYear[year] = (totalByYear[year] || 0) + amount;
    });
  });

  let summaryText = "Totalkostnad per år:";

  if (matchedRows.length === 0) {
    summaryDiv.textContent = summaryText + "\nInga valda avtal.";
    return;
  }

  const sortedYears = Object.keys(totalByYear)
    .map(year => year.toString())
    .filter(year => year !== "" && !Number.isNaN(parseInt(year, 10)))
    .sort((a, b) => parseInt(a, 10) - parseInt(b, 10));

  if (sortedYears.length === 0) {
    summaryDiv.textContent = summaryText + "\nIngen kostnadsinformation tillgänglig för urvalet.";
    return;
  }

  for (let y of sortedYears) {
    const amount = totalByYear[y] || 0;
    summaryText += `\n${y}: ${amount.toLocaleString("sv-SE", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kr`;
  }
  summaryDiv.textContent = summaryText;
}
</script>
</body>
</html>
